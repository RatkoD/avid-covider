- description: תסריט לניהול שיחות מצד הפונה
  name: פונה
  snippets:
    - name: default
      steps:
      - goto: intro
      - goto: reporting-loop
      - goto: end-of-report

    - name: intro
      steps:
        - do:
            cmd: load_local_storage                 # Load the data of previous reports on device
            params:
            - record
        - switch:
            arg: _existing_user
            cases:
            - match: new                                                           # <--- First report on device
              steps:
              - say: טוב שבאת,
              - say: כולם מנסים לחזור לשיגרה מסויימת אבל מגפת הקורונה לא נעלמה
              - say: התשובות שלך לכמה שאלות, והמשך הדיווח, יעזרו לצוות המחקר של מכון ויצמן לאתר מוקדים אפשריים להתפרצות מחודשת של המחלה ולהיערך אליה בהתאם.
              - say: כל השאלות והמידע ישארו אנונימיים ויכבדו את הפרטיות שלך
              - say: נתחיל בדיווח עבורך, בסופו יתאפשר גם דיווח עבור בני משפחה נוספים
              - say: הכי טוב כשכולם מדווחים על עצמם בכל יום אבל אם זה לא מסתדר, אפשר להקריא להם את השאלות או פשוט לענות בשמם
            - match: returning                                                     # <--- Previous reports found on device
              steps:
              - say: הי! טוב לראותך שוב
              - say: ננסה יחד איתך להבין מה הסיכוי להתפרצות מחודשת של קורונה באזור שלך
              - say: אם אחרי הדיווח שלך נוכל לקבל דיווח גם עבור בני המשפחה או בני הבית האחרים, זה יעזור לנו מאוד

    - name: reporting-loop
      steps:
        - do:
            cmd: clear
        - goto: personal-details
        - goto: preconditions-check

        - goto: covid19
        - goto: hospitalization
        - goto: insulation

        - goto: routine
        - goto: current-report
        - goto: exposures
        - do:
            cmd: save_report
            params:
              - record
        - do:
            cmd: clear_state
        - say: מצויין, השלמנו את הדיווח היומי עבור {{alias}}
        - goto: reporting-loop
              
    - name: personal-details
      steps:
        - do:
            cmd: load_local_storage                 # Load the data of previous reports on device
            params:
            - record

        - switch:
            arg: _existing_user
            cases:
            - match: new
            - match: returning                                                     # <--- Previous reports found on device
              steps:
              - say: עבור מי ברצונך לדווח עכשיו?
              - do:
                  cmd: fetch_previous_reports                            # <--- Generate the list of options (reporters) to show
                  variable: _report_options
                  params:
                    - "דיווח חדש ב{{street}} {{city_town}}"
                    - "דיווח חדש בכתובת אחרת"
                    - "זהו להיום"
              - wait:                                                    # <---- wait for the user choice of the current reporter
                  optionsFrom: _report_options
                  variable: _report_selection
              - do:
                  cmd: update_from_selection
                  params:
                    - record
                    - _report_selection                    
                            
        - switch:
            arg: sex
            cases:
            - undefined: true                          # <---- for new reporters, ask for sex
              steps:
              - say: בן? בת?
              - wait:
                  variable: sex
                  options:
                  - show: בן
                    value: male
                  - show: בת
                    value: female
                  - show: אחר
                    value: other
            - default: true                          # <---- for returning reporters, pass

        - switch:
            arg: age
            cases:
            - undefined: true                       # <---- for new reporters, ask for age
              steps:
              - switch:
                  arg: sex
                  cases:
                  - match: male
                    steps:
                    - say: בן כמה?
                  - match: female
                    steps:
                    - say: בת כמה?
                  - match: other
                    steps:
                    - say: מה הגיל שלך?
              - wait:
                  variable: age
                  placeholder: "גיל, 0-120"
                  input-kind: number
                  input-min: 0
                  input-max: 120
            - default: true                       # <---- for returning reporters, pass

        - switch:
            arg: city_town
            cases:
            - undefined: true                    # <---- for new reporters, ask for city
              steps:   
              - do:
                  cmd: prepare_city_town_suggestions
                  variable: _cityTownSuggestions
              - say: מה הוא מקום המגורים?
              - wait:
                  variable: city_town
                  placeholder: "שם העיר או הישוב"
                  suggestionsFrom: _cityTownSuggestions
            - default: true                     # <---- for returning reporters, pass

        - switch:
            arg: street
            cases:
            - undefined: true                 # <---- for new reporters, ask for street name
              steps:   
              - say: שם הרחוב?
              - wait:
                  variable: street
                  placeholder: שם הרחוב, אם ידוע
                  required: false
            - default: true                   # <---- for returning reporters, pass

        - do:
            cmd: ensure_uid
            params:
              - record

        - switch:
            arg: _location                    # _location is the concatenation of an optional street and the city
            cases:
            - undefined: true                 # <---- for new users, create _location
              steps:
              - do:
                  cmd: combine_location
                  variable: _location
                  params:
                    - record
                    - "{{street}} {{city_town}}"
            - default: true                   # <---- for returning users, we already have saved _location

        - switch:
            arg: alias                         # alias is our user identifier (age+sex+street+city)
            cases:
            - undefined: true                            #<--- for new users, create alias
              steps:
              - do:
                  cmd: calculate_alias
                  variable: alias
                  params:
                    - record
                    - "בן {{age}} מ{{_location}}"
                    - "בת {{age}} מ{{_location}}"
                    - "גיל {{age}} מ{{_location}}"
              - say: נהדר, בכדי לשמור על הפרטיות שלך, בדיווחים הבאים נקרא לך פשוט {{alias}}
            - default: true                 # <---- for returning users, we already have saved alias

        - do:                                   # <---- check whether the reporter is an adult (18 years old and older) or a minor
            cmd: is_adult
            params: 
              - record
            variable: _is_adult

        - do:                                   # <---- check whether the reporter is an adult (65 years old and older) or a minor
            cmd: is_old
            params: 
              - record
            variable: _is_old

        - do:                                       # <---- check if we already have the household data from past reports
            cmd: fetch_household_data
            params: 
              - record

        - switch:
            arg: _household_data_available
            cases:
            - match: true
            - default: true
              steps:
              - say: "יש לנו כמה שאלות (שנשאל פעם אחת) לגבי הבית ב{{_location}} -"
              - say: כמה מבוגרים מעל לגיל 18 גרים בבית?
              - switch:
                  arg: _is_adult
                  cases:
                    - match: true
                      steps:
                      - wait:
                          variable: _household_adults
                          placeholder: מספר המבוגרים ,1-99
                          validation: "[0-9]+"
                          input-kind: number
                          input-min: 1
                          input-max: 99
                    - match: false
                      steps:
                      - wait:
                          variable: _household_adults
                          placeholder: מספר המבוגרים ,0-99
                          validation: "[0-9]+"
                          input-kind: number
                          input-min: 0
                          input-max: 99
                
              - say: וכמה ילדים מתחת לגיל 18?
              - switch:
                  arg: _is_adult
                  cases:
                    - match: true
                      steps:
                      - wait:
                          variable: _household_minors
                          placeholder: מספר הילדים, 0-99
                          validation: "[0-9]+"
                          input-kind: number
                          input-min: 0
                          input-max: 99
                    - match: false
                      steps:
                      - wait:
                          variable: _household_minors
                          placeholder: מספר הילדים, 1-99
                          validation: "[0-9]+"
                          input-kind: number
                          input-min: 1
                          input-max: 99

        - switch:
            arg: _is_old
            cases:
            - default: true
            - match: true 
              steps:
              - switch:
                  arg: is_assisted_living
                  cases:
                  - default: true
                  - undefined: true
                    steps:
                    - say: האם מקום המגורים הנוכחי שלך הוא דיור מוגן או בית אבות?
                    - wait:
                        variable: is_assisted_living
                        options:
                          - show: כן, דיור מוגן או בית אבות
                            value: true
                          - show: לא
                            value: false
                          - show: לא רוצה להשיב
                            value: no_response

    - name: preconditions-check
      steps:
        - switch:
            arg: preconditions_received
            cases:
              - undefined: true                  # <---- for new reporters, ask for preconditions (go to relevant block)
                steps:
                - goto: preconditions
              - default: true                    # <---- for returning reporters, pass

    - name: preconditions
      steps:
        - say: "אשאל אותך על מחלות, שחשוב לנו לדעת אם אובחנו אצלך בעבר או שיש לך כיום:"
        - goto: preconditions-diseases
        - goto: preconditions-smoking
        - do:
            cmd: set_flag
            params:
              - record
              - preconditions_received
        - say: אוקיי, עברנו את זה…     

    - name: preconditions-diseases
      steps:
        - wait:
            variable: _var
            multi: true
            options:
            - show: "סוכרת"
              field: precondition_chronic_diabetes
            - show: "בעיית יתר לחץ דם"
              field: precondition_chronic_hypertension
            - show: מחלת לב, כלי דם או שבץ
              field: precondition_chronic_ischemic_heart_disease_or_stroke
            - show: מחלת ריאות כרונית כולל אסתמה (ללא אסתמה בילדות)
              field: precondition_chronic_lung_disease
            - show: סרטן
              field: precondition_chronic_cancer
            - show: אי ספיקת כליות
              field: precondition_chronic_kidney_failure
            - show: דיכוי חיסוני לרבות נטילת תרופות המדכאות את מערכת החיסון
              field: precondition_chronic_immune_system_suppression
            - show: |-
                <span class='empty'>אף אחת ממחלות הרקע הללו</span>
                <span class='not-empty'>זהו</span>
                <span class='none-selected'>ללא מחלות רקע</span>
              class: other
        - do:
            cmd: update_from_selection
            params:
              - record
              - _var
    
    - name: preconditions-smoking
      steps:
        - say: מה לגבי עישון?
        - wait:
            variable: precondition_smoking
            options:
              - show: עישון יומיומי
                value: daily_smoker
              - show: עישנתי בעבר, הפסקתי לפני פחות מחמש שנים
                value: short_past_smoker
              - show: עישנתי בעבר, לפני יותר מחמש שנים
                value: long_past_smoker
              - show: אף פעם
                class: other
                value: never

    - name: covid19
      steps:
        - switch:
            arg: covid_positive
            cases:
              - undefined: true
                steps:
                  - say: האם אובחנת בעבר כחולה בקורונה בבדיקת PCR?
                  - wait:
                      variable: covid_positive
                      options:
                        - show: כן
                          value: "true"
                          steps:
                            - say: מתי קיבלת את האבחנה החיובית?
                            - wait:
                                variable: covid_last_positive_results_date
                                placeholder: "תאריך: dd/mm/yy"
                                input-kind: date

                        - show: כן, אבל החלמתי מאז
                          value: "recovered"
                          steps:
                            - say: מתי קיבלת את האבחנה החיובית?
                            - wait:
                                variable: covid_last_positive_results_date
                                placeholder: "תאריך: dd/mm/yy"
                                input-kind: date
                            - say: האם ביצעת מאז בדיקה נוספת שמסקנתה היתה שאין לך קורונה?
                            - wait:
                                options:
                                  - show: כן
                                    steps:
                                      - say: מתי זה היה?
                                      - wait:
                                          variable: covid_last_negative_results_date
                                          placeholder: "תאריך: dd/mm/yy"
                                          input-kind: date
        
                                  - show: לא
                        - show: לא
                          value: "no"
              - default: true
                steps:
                  - say: האם אובחנת מאז הדיווח האחרון כחולה בקורונה בבדיקת PCR?
                  - switch:
                      arg: covid_positive
                      cases:
                      - match: true
                        steps:
                          - wait:
                              variable: covid_positive
                              options:
                                - show: אני עדיין חולה
                                  value: "true"
                                - show: ביצעתי בדיקה אבל קיבלתי תוצאה שלילית
                                  value: "false"
                                  steps:
                                    - say: מתי זה היה?
                                    - wait:
                                        variable: covid_last_negative_results_date
                                        placeholder: "תאריך: dd/mm/yy"
                                        input-kind: date
                                - show: לא, אבל החלמתי מהקורונה
                                  value: "recovered"

                      - match: false
                        steps:
                          - wait:
                              variable: covid_positive
                              options:
                                - show: כן
                                  value: "true"
                                  steps:
                                    - say: מתי זה היה?
                                    - wait:
                                        variable: covid_last_positive_results_date
                                        placeholder: "תאריך: dd/mm/yy"
                                        input-kind: date
                                - show: ביצעתי בדיקה אבל קיבלתי תוצאה שלילית
                                  value: "false"
                                  steps:
                                    - say: מתי זה היה?
                                    - wait:
                                        variable: covid_last_negative_results_date
                                        placeholder: "תאריך: dd/mm/yy"
                                        input-kind: date

                                - show: לא
                                  value: "no"

        - do:
            cmd: handle_no_covid
            params:
              - record


    - name: hospitalization
      steps:
        - switch:
            arg: covid_positive
            cases:
              - match: true
              - default: true
                steps:
                  - pop: reporting-loop
        - switch:
            arg: hospitalization_status
            cases:
              - match: true
                steps:
                  - say: האם אתם עדיין באשפוז?
                  - wait:
                      variable: hospitalization_status
                      options:
                        - show: כן, אני עדיין באשפוז
                          value: "true"
                        - show: לא, כבר שוחררתי
                          value: "false"
                          steps:
                            - say: מתי השתחחרת?
                            - wait:
                                variable: hospitalization_end_date
                                placeholder: "תאריך: dd/mm/yy"
                                input-kind: date
                            - goto: hospitalization_icu

              - match: false
                steps:
                  - say: האם מאז הדיווח האחרון התאשפזת?
                  - wait:
                      variable: hospitalization_status
                      options:
                        - show: כן, אני באשפוז
                          value: "true"
                          steps:
                            - say: מתי התחיל האשפוז?
                            - wait:
                                variable: hospitalization_start_date
                                placeholder: "תאריך: dd/mm/yy"
                                input-kind: date
                        - show: כן, אבל כבר שוחררתי
                          value: "false"
                          steps:
                            - say: מתי התחיל האשפוז?
                            - wait:
                                variable: hospitalization_start_date
                                placeholder: "תאריך: dd/mm/yy"
                                input-kind: date
                            - say: ומתי השתחחרת?
                            - wait:
                                variable: hospitalization_end_date
                                placeholder: "תאריך: dd/mm/yy"
                                input-kind: date
                            - goto: hospitalization_icu
                        - show: לא
                          value: "no"

              - undefined: true
                steps:
                  - say: האם בעקבות זאת נזקקת לאשפוז?
                  - wait:
                      variable: hospitalization_status
                      options:
                        - show: כן, אני באשפוז כרגע
                          value: "true"
                          steps:
                            - say: מתי התחיל האשפוז?
                            - wait:
                                variable: hospitalization_start_date
                                placeholder: "תאריך: dd/mm/yy"
                                input-kind: date

                        - show: כן, וכבר שוחררתי
                          value: "false"
                          steps:
                            - say: באיזה תאריך התאשפזת?
                            - wait:
                                variable: hospitalization_start_date
                                placeholder: "תאריך: dd/mm/yy"
                                input-kind: date
                            - say: ומתי השתחחרת?
                            - wait:
                                variable: hospitalization_end_date
                                placeholder: "תאריך: dd/mm/yy"
                                input-kind: date
                            - goto: hospitalization_icu

                        - show: לא
                          value: "no"

        - do:
            cmd: clear_insulation_status
            params:
              - record


    - name: hospitalization_icu
      steps:
        - say: האם אושפזת גם בטיפול נמרץ?
        - wait:
            variable: hospitalization_icu_required
            options:
              - show: כן
                value: true
                steps:
                  - say: כמה ימים אושפזת שם?
                  - wait:
                      variable: hospitalization_icu_duration
                      input-kind: number
                      input-step: 1
                      input-min: 1
                      input-max: 999
                      placeholder: מספר הימים  

              - show: לא
                value: false

    - name: insulation
      steps:
        - switch:
            arg: hospitalization_status
            cases:
              - match: true
                steps:
                  - pop: reporting-loop
              - default: true
        - switch:
            arg: insulation_status
            cases:
              - undefined: true
                steps:
                  - say: האם היית היום בבידוד?
                  - wait:
                      variable: insulation_status
                      options:
                        - show: כן, בבית שלי ובנפרד מבני משפחתי
                          value: insulation
                        - show: כן, בבית שלי
                          value: insulation_with_family
                        - show: כן, במלון
                          value: insulation_hotel
                        - show: אני לא בבידוד
                          value: none
              - match: none
                steps:
                  - say: האם מאז הדיווח האחרון נכנסת לבידוד?
                  - wait:
                      variable: insulation_status
                      options:
                        - show: כן, בבית שלי ובנפרד מבני משפחתי
                          value: insulation
                        - show: כן, בבית שלי
                          value: insulation_with_family
                        - show: כן, במלון
                          value: insulation_hotel
                        - show: לא
                          value: none
              - default: true
                steps:
                  - say: האם אתם עדיין בבידוד?
                  - wait:
                      variable: insulation_status
                      options:
                        - show: כן, בבית שלי ובנפרד מבני משפחתי
                          value: insulation
                        - show: כן, בבית שלי
                          value: insulation_with_family
                        - show: כן, במלון
                          value: insulation_hotel
                        - show: אני כבר לא בבידוד
                          value: none

        - do:
            cmd: clear_insulation_reason
            params:
              - record
        - switch:
            arg: insulation_status
            cases:
              - match: none
              - default: true
                steps:
                  - switch:
                      arg: insulation_reason
                      cases:
                        - default: true
                        - match: none
                          steps:
                            - say: למה אתם בבידוד?
                            - wait:
                                variable: insulation_reason
                                options:
                                  - show: אני בבידוד כי חזרתי מחו״ל לאחרונה
                                    value: back_from_abroad
                                  - show: אני בבידוד כי נחשפתי לחולה מאומת
                                    value: contact_with_patient
                                  - show: אני בבידוד כי חוויתי תסמינים
                                    value: has_symptoms
                                  - show: אני בבידוד מרצוני האישי
                                    value: voluntary
                            - say: ממתי אתם בבידוד?
                            - wait:
                                variable: insulation_start_date
                                placeholder: "תאריך: dd/mm/yy"
                                input-kind: date

    - name: routine
      steps:
        - switch:
            arg: _is_adult
            cases:
              - default: true
              - match: true
                steps:
                  - do:
                      cmd: need_to_ask_about_routine
                      variable: _need_to_ask_about_routine
                      params:
                        - record
                  - switch:
                      arg: _need_to_ask_about_routine
                      cases:
                        - match: false
                        - match: true
                          steps:
                          - say: "יש כמה שאלות חשובות שאנחנו שואלים את כולם, רק פעם בשבוע, כדי להקל על הדיווח"
                          - say: האם יצאת מהבית במהלך השבוע האחרון?
                          - wait:
                              variable: routine_left_the_house
                              options:
                                - show: כן, יצאתי
                                  value: true
                                  steps:
                                    - say: האם יש לך עבודה קבועה מחוץ לבית בימים אלה?
                                    - wait:
                                        variable: routine_workplace_is_outside
                                        options:
                                        - show: כן, יש עבודה מחוץ לבית
                                          value: true 
                                          steps:
                                          - say: וכמה שעות, פחות או יותר, עבדת שם בשבוע האחרון?
                                          - wait:
                                              variable: routine_workplace_weekly_hours
                                              input-kind: number
                                              input-step: 1
                                              input-min: 0
                                              input-max: 168
                                              placeholder: מספר השעות, בערך  
                                          - say: האם העבודה במקום קבוע?
                                          - wait:
                                              variable: routine_workplace_single_location
                                              options:
                                              - show: כן, במקום קבוע
                                                value: true
                                                steps:
                                                - say: אפשר לשאול איפה נמצא מקום העבודה? זה יכול לעזור לנו במחקר
                                                - wait:
                                                    options:
                                                    - show: כן, בטח
                                                      steps:
                                                        - do:
                                                            cmd: prepare_city_town_suggestions
                                                            variable: _cityTownSuggestions
                                                        - say: איפה נמצא מקום העבודה?
                                                        - wait:
                                                            variable: routine_workplace_city_town
                                                            placeholder: "שם העיר או הישוב"
                                                            suggestionsFrom: _cityTownSuggestions
                                                        - say: ובאיזה רחוב זה?
                                                        - wait:
                                                            variable: routine_workplace_street
                                                            placeholder: שם הרחוב, אם ידוע
                                                            required: false
                                                    - show: עדיף שלא
                                              - show: לא, אין כתובת קבועה בעבודה
                                                value: false
                
                                          - say: "האם באחד מן הימים בשבוע האחרון נתת שירות בעבודתך ליותר מ-10 אנשים?"
                                          - wait:
                                              variable: _served_public_last_fortnight
                                              options:
                                              - show: כן, נתתי שירות
                                                value: true
                                              - show: לא נתתי שירות
                                                value: false
          
                                          - switch:
                                              arg: medical_staff_member
                                              cases:
                                              - undefined: true        # <---- ask new/returning users with no past info about the kind work
                                                steps:
                                                - say: האם העבודה שלך היא כחלק מצוות רפואי - בטיפול בחולים או בקבלת קהל?
                                                - wait:
                                                    variable: medical_staff_member
                                                    options:
                                                    - show: כן, אני חלק מצוות רפואי
                                                      value: true
                                                    - show: לא, אני לא
                                                      value: false
                                              - default: true            # <---- for returning users past info about the kind work, pass
                
                                        - show: לא
                                          value: false
          
                                    - switch:
                                        arg: routine_visits_prayer_house
                                        cases:
                                          - default: true 
                                          - undefined: true 
                                            steps:
                                            - say: האם ביקרת בבית תפילה באופן שגרתי השבוע?
                                            - wait:
                                                variable: routine_visits_prayer_house
                                                options:
                                                - show: כן
                                                  value: true
                                                - show: לא
                                                  value: false
                                                - show: לא רוצה להשיב
                                                  value: no_response
                                                  class: other

                                    - say: האם יצא לך להשתמש בתחבורה ציבורית בשבוע האחרון?          
                                    - wait:
                                        variable: routine_uses_public_transportation
                                        options:
                                          - show: כן
                                            value: true
                                            steps:
                                            - say: במה מאלה השתמשת השבוע?
                                            - wait:
                                                variable: _var
                                                multi: true
                                                options:
                                                - show: "רכבת"
                                                  field: routine_uses_public_transportation_train
                                                - show: "אוטובוס"
                                                  field: routine_uses_public_transportation_bus 
                                                - show: "מונית"
                                                  field: routine_uses_public_transportation_taxi
                                                - show: "אחר"
                                                  field: routine_uses_public_transportation_other
                                                - show: |-
                                                    <span class='empty'>בעצם לא</span>
                                                    <span class='not-empty'>זהו</span>
                                                    <span class='none-selected'>אין פרטים נוספים</span>
                                                  class: other
                                            - do:
                                                cmd: update_from_selection
                                                params:
                                                  - record
                                                  - _var
                                              
                                          - show: לא
                                            value: false

                                    - say: "האם חבשת השבוע מסיכה כשיצאת מהבית?"
                                    - wait:
                                        variable: routine_wears_mask
                                        options:
                                        - show: כן, תמיד
                                          value: always
                                        - show: רוב הזמן
                                          value: mostly_yes
                                        - show: בחלק קטן מהזמן
                                          value: mostly_no
                                        - show: לא
                                          value: never
                                        - show: לא רוצה להשיב
                                          value: no_response
                                          class: "other"

                                - show: לא, נשארתי בבית
                                  value: false

        - do:
            cmd: save_public_service_data
            params: 
              - record

    - name: current-report
      steps:
        - switch:
            arg: general_feeling                                      
            cases:
              - default: true                                          #<--- for new reporters, ask how they fell
                steps:
                - say: ומה נשמע היום?
                - wait:
                    variable: general_feeling
                    options:
                    - show: בסדר גמור
                      value: feel_good
                      steps:
                        - say: נהדר לשמוע!
                        - say: "ליתר בטחון, האם יש משהו מהתסמינים האלה?"
                    - show: לא כל כך טוב
                      value: feel_bad
                      steps:
                      - say: "אוייש… איך זה בא לידי ביטוי?"
      
              - match: feel_good                                      #<--- for returning users who felt good on their previous report
                steps:
                  - say: אני מקווה שהמרגש עדיין טוב כמו בדיווח הקודם
                  - wait:
                      variable: general_feeling
                      options:
                      - show: כן, בסדר גמור
                        value: feel_good
                        steps:
                          - say: נהדר לשמוע!
                          - say: "ליתר בטחון, האם יש משהו מהתסמינים האלה?"
                      - show: לצערי לא כל כך טוב
                        value: feel_bad
                        steps:
                        - say: "אוייש… איך זה בא לידי ביטוי?"
        
              - match: feel_bad                                    #<--- for returning users who felt bad on their previous report
                steps:
                  - say: בדיווח שעבר סיפרת שהרגשת לא כל כך טוב… האם חל שיפור במצבך?
                  - wait:
                      variable: general_feeling
                      options:
                      - show: כן, עכשיו הכל בסדר
                        value: feel_good
                        steps:
                          - say: נהדר לשמוע!
                          - say: "ליתר בטחון, האם יש משהו מהתסמינים האלה?"
                      - show: לא, עדיין לא משהו
                        value: feel_bad
                        steps:
                        - say: "אוייש… איך זה בא לידי ביטוי?"

        - goto: current-report-symptoms

    - name: current-report-symptoms
      steps:
        - goto: current-report-top-level-symptoms
        - switch:
            arg: covid_positive
            cases:
              - default: true
              - match: true
                steps:
                  - switch:
                      arg: symptoms_breath_shortness
                      cases:
                        - default: true
                        - match: true
                          steps:
                            - switch:
                                arg: symptoms_breath_shortness_duration
                                cases:
                                  - default: true
                                  - undefined: true
                                    steps:
                                      - say: לפני כמה ימים התחיל קוצר הנשימה?
                                      - wait:
                                          variable: symptoms_breath_shortness_duration
                                          placeholder: מספר הימים
                                          input-kind: number
                                          input-min: 0
                                          input-max: 100
                                          input-step: 1
                  - switch:
                      arg: symptoms_diarrhea
                      cases:
                        - default: true
                        - match: true
                          steps:
                            - switch:
                                arg: symptoms_diarrhea_duration
                                cases:
                                  - default: true
                                  - undefined: true
                                    steps:
                                      - say: לפני כמה ימים התחיל השלשול?
                                      - wait:
                                          variable: symptoms_diarrhea_duration
                                          placeholder: מספר הימים
                                          input-kind: number
                                          input-min: 0
                                          input-max: 100
                                          input-step: 1
                  - switch:
                      arg: symptoms_lack_of_appetite_or_skipping_meals
                      cases:
                        - default: true
                        - match: true
                          steps:
                            - switch:
                                arg: symptoms_lack_of_appetite_or_skipping_meals_duration
                                cases:
                                  - default: true
                                  - undefined: true
                                    steps:
                                      - say: לפני כמה ימים התחיל חוסר התיאבון?
                                      - wait:
                                          variable: symptoms_lack_of_appetite_or_skipping_meals_duration
                                          placeholder: מספר הימים
                                          input-kind: number
                                          input-min: 0
                                          input-max: 100
                                          input-step: 1
                  - switch:
                      arg: symptoms_nausea_and_vomiting
                      cases:
                        - default: true
                        - match: true
                          steps:
                            - switch:
                                arg: symptoms_nausea_and_vomiting_duration
                                cases:
                                  - default: true
                                  - undefined: true
                                    steps:
                                      - say: לפני כמה ימים התחילו הבחילה או ההקאות?
                                      - wait:
                                          variable: symptoms_nausea_and_vomiting_duration
                                          placeholder: מספר הימים
                                          input-kind: number
                                          input-min: 0
                                          input-max: 100
                                          input-step: 1
                  - switch:
                      arg: symptoms_chills
                      cases:
                        - default: true
                        - match: true
                          steps:
                            - switch:
                                arg: symptoms_chills_duration
                                cases:
                                  - default: true
                                  - undefined: true
                                    steps:
                                      - say: לפני כמה ימים התחילו הצמרמורות?
                                      - wait:
                                          variable: symptoms_chills_duration
                                          placeholder: מספר הימים
                                          input-kind: number
                                          input-min: 0
                                          input-max: 100
                                          input-step: 1
                  - switch:
                      arg: symptoms_confusion
                      cases:
                        - default: true
                        - match: true
                          steps:
                            - switch:
                                arg: symptoms_confusion_duration
                                cases:
                                  - default: true
                                  - undefined: true
                                    steps:
                                      - say: לפני כמה ימים התחיל הבלבול?
                                      - wait:
                                          variable: symptoms_confusion_duration
                                          placeholder: מספר הימים
                                          input-kind: number
                                          input-min: 0
                                          input-max: 100
                                          input-step: 1
                  - switch:
                      arg: symptoms_tiredness_or_fatigue
                      cases:
                        - default: true
                        - match: true
                          steps:
                            - switch:
                                arg: symptoms_tiredness_or_fatigue_duration
                                cases:
                                  - default: true
                                  - undefined: true
                                    steps:
                                      - say: לפני כמה ימים התחילו העייפות או החולשה?
                                      - wait:
                                          variable: symptoms_tiredness_or_fatigue_duration
                                          placeholder: מספר הימים
                                          input-kind: number
                                          input-min: 0
                                          input-max: 100
                                          input-step: 1
                  - switch:
                      arg: symptoms_smell_taste_loss
                      cases:
                        - default: true
                        - match: true
                          steps:
                            - switch:
                                arg: symptoms_smell_taste_loss_duration
                                cases:
                                  - default: true
                                  - undefined: true
                                    steps:
                                      - say: לפני כמה ימים אבד חוש הטעם או הריח?
                                      - wait:
                                          variable: symptoms_smell_taste_loss_duration
                                          placeholder: מספר הימים
                                          input-kind: number
                                          input-min: 0
                                          input-max: 100
                                          input-step: 1


        - goto: current-report-cough-symptoms

        - switch:
            arg: covid_positive
            cases:
              - default: true
              - match: true
                steps:
                  - switch:
                      arg: symptoms_clogged_nose
                      cases:
                        - default: true
                        - match: true
                          steps:
                            - switch:
                                arg: symptoms_clogged_nose_duration
                                cases:
                                  - default: true
                                  - undefined: true
                                    steps:
                                      - say: לפני כמה ימים התחילו הנזלת או הגודש באף?
                                      - wait:
                                          variable: symptoms_clogged_nose_duration
                                          placeholder: מספר הימים
                                          input-kind: number
                                          input-min: 0
                                          input-max: 100
                                          input-step: 1
                  - switch:
                      arg: symptoms_dry_cough
                      cases:
                        - default: true
                        - match: true
                          steps:
                            - switch:
                                arg: symptoms_dry_cough_duration
                                cases:
                                  - default: true
                                  - undefined: true
                                    steps:
                                      - say: לפני כמה ימים התחיל השיעול היבש?
                                      - wait:
                                          variable: symptoms_dry_cough_duration
                                          placeholder: מספר הימים
                                          input-kind: number
                                          input-min: 0
                                          input-max: 100
                                          input-step: 1
                  - switch:
                      arg: symptoms_moist_cough
                      cases:
                        - default: true
                        - match: true
                          steps:
                            - switch:
                                arg: symptoms_moist_cough_duration
                                cases:
                                  - default: true
                                  - undefined: true
                                    steps:
                                      - say: לפני כמה ימים התחיל השיעול הלח, או השיעול עם הכיח?
                                      - wait:
                                          variable: symptoms_moist_cough_duration
                                          placeholder: מספר הימים
                                          input-kind: number
                                          input-min: 0
                                          input-max: 100
                                          input-step: 1

        - goto: current-report-pain-symptoms

        - switch:
            arg: covid_positive
            cases:
              - default: true
              - match: true
                steps:
                  - switch:
                      arg: symptoms_muscles_pain
                      cases:
                        - default: true
                        - match: true
                          steps:
                            - switch:
                                arg: symptoms_muscles_pain_duration
                                cases:
                                  - default: true
                                  - undefined: true
                                    steps:
                                      - say: לפני כמה ימים התחילו כאבי השרירים?
                                      - wait:
                                          variable: symptoms_muscles_pain_duration
                                          placeholder: מספר הימים
                                          input-kind: number
                                          input-min: 0
                                          input-max: 100
                                          input-step: 1
                  - switch:
                      arg: symptoms_headache
                      cases:
                        - default: true
                        - match: true
                          steps:
                            - switch:
                                arg: symptoms_headache_duration
                                cases:
                                  - default: true
                                  - undefined: true
                                    steps:
                                      - say: לפני כמה ימים התחילו כאבי הראש?
                                      - wait:
                                          variable: symptoms_headache_duration
                                          placeholder: מספר הימים
                                          input-kind: number
                                          input-min: 0
                                          input-max: 100
                                          input-step: 1
                  - switch:
                      arg: symptoms_sore_throat
                      cases:
                        - default: true
                        - match: true
                          steps:
                            - switch:
                                arg: symptoms_sore_throat_duration
                                cases:
                                  - default: true
                                  - undefined: true
                                    steps:
                                      - say: לפני כמה ימים התחילו כאבי הגרון?
                                      - wait:
                                          variable: symptoms_sore_throat_duration
                                          placeholder: מספר הימים
                                          input-kind: number
                                          input-min: 0
                                          input-max: 100
                                          input-step: 1
                  - switch:
                      arg: symptoms_abdominal_pain
                      cases:
                        - default: true
                        - match: true
                          steps:
                            - switch:
                                arg: symptoms_abdominal_pain_duration
                                cases:
                                  - default: true
                                  - undefined: true
                                    steps:
                                      - say: לפני כמה ימים התחילו כאבי הבטן?
                                      - wait:
                                          variable: symptoms_abdominal_pain_duration
                                          placeholder: מספר הימים
                                          input-kind: number
                                          input-min: 0
                                          input-max: 100
                                          input-step: 1
                  - say: האם חשת בתסמינים אחרים בימים האחרונים? אם כן, מהם?
                  - wait:
                      variable: symptoms_other
                      required: false

        - goto: current-report-temperature

    - name: current-report-temperature
      steps:
        - switch:
            arg: general_feeling
            cases:
            - match: feel_good
              steps:
                - say: "למרות שאמרת קודם שההרגשה טובה, כדאי בתקופה הזו למדוד כל יום את חום הגוף."
                - say: "האם כבר נמדד חום היום?"
                - wait:
                    options:
                      - show: "כן, נמדד חום"
                        steps:
                          - goto: current-report-ask-body-temperature
                      - show: "היום לא נמדד חום"

            - match: feel_bad
              steps:
                - say: "האם נמדד חום היום?"
                - wait:
                    options:
                      - show: "כן, נמדד חום"
                        steps:
                          - goto: current-report-ask-body-temperature
                      - show: "היום לא נמדד חום"

    - name: current-report-ask-body-temperature
      steps:
        - say: "ומה בדיוק המדחום אומר?"
        - wait:
            variable: temperature
            placeholder: מעלות חום, 35.0-43.0
            input-kind: number
            input-min: 35
            input-max: 43
            input-step: 0.1
              
    - name: current-report-top-level-symptoms
      steps:
      - wait:
          variable: _var
          multi: true
          options:
            - show: שיעולים או נזלת
              field: toplevel_symptoms_cough
            - show: קוצר נשימה
              field: symptoms_breath_shortness
            - show: כאבים
              field: toplevel_symptoms_pains
            - show: שלשול
              field: symptoms_diarrhea
            - show: חוסר תאבון או דילוג על ארוחות
              field: symptoms_lack_of_appetite_or_skipping_meals                            
            - show: בחילה או הקאות
              field: symptoms_nausea_and_vomiting
            - show: צמרמורת
              field: symptoms_chills
            - show: בלבול
              field: symptoms_confusion
            - show: עייפות או חולשה
              field: symptoms_tiredness_or_fatigue
            - show: איבדתי את חוש הטעם או הריח
              field: symptoms_smell_taste_loss
            - show: |-
                <span class='empty'>אף אחד מהתסמינים האלה</span>
                <span class='not-empty'>זהו</span>
                <span class='none-selected'>אין תסמינים</span>
              class: other
      - do:
          cmd: update_from_selection
          params:
            - record
            - _var

    - name: current-report-cough-symptoms
      steps:
      - switch:
          arg: toplevel_symptoms_cough
          cases:
            - default: true
            - match: true
              steps:
              - say: נשמח לעוד כמה פרטים לגבי השיעול והנזלת. 
              - wait:
                  variable: _var
                  multi: true
                  options:
                  - show: נזלת או גודש באף
                    field: symptoms_clogged_nose
                  - show: שיעול יבש
                    field: symptoms_dry_cough
                  - show: שיעול לח, או שיעול עם כיח
                    field: symptoms_moist_cough
                  - show: |-
                      <span class='empty'>אף אחד מהתסמינים האלה</span>
                      <span class='not-empty'>זהו</span>
                      <span class='none-selected'>אין פרטים נוספים</span>
                    class: other
              - do:
                  cmd: update_from_selection
                  params:
                    - record
                    - _var

    - name: current-report-pain-symptoms
      steps:
      - switch:
          arg: toplevel_symptoms_pains
          cases:
            - default: true
            - match: true
              steps:
              - say: מה כואב בדיוק?
              - wait:
                  variable: _var
                  multi: true
                  options:
                  - show: כאבי שרירים
                    field: symptoms_muscles_pain
                  - show: כאבי ראש
                    field: symptoms_headache
                  - show: כאבי גרון
                    field: symptoms_sore_throat
                  - show: כאבי בטן
                    field: symptoms_abdominal_pain
                  - show: |-
                      <span class='empty'>אף אחד מהתסמינים האלה</span>
                      <span class='not-empty'>זהו</span>
                      <span class='none-selected'>אין פרטים נוספים</span>      
                    class: other
              - do:
                  cmd: update_from_selection
                  params:
                    - record
                    - _var

    - name: exposures
      steps:
        - say: "הרבה אנשים נפגשים עכשיו, בעבודה ובמקומות אחרים -"
        - say: "האם ביממה האחרונה שהית בקרבת אנשים (<b>שאינם בני הבית</b>) למשך יותר מ-15 דקות ובמרחק של פחות מ-2 מטרים"
        - wait:
            options:
              - show: לא
              - show: כן
                steps:
                - say: וכמה מהם היו מבוגרים מעל גיל 18?
                - wait:
                    variable: _met_above_18
                    placeholder: מספר המבוגרים, 0-99, אם לא ידוע ניתן להשאיר ריק
                    required: false
                    input-kind: number
                    input-min: 0
                    input-max: 99
                - say: וכמה ילדים מתחת לגיל 18?
                - wait:
                    variable: _met_under_18
                    placeholder: מספר הילדים, 0-99, אם לא ידוע ניתן להשאיר ריק
                    required: false
                    input-kind: number
                    input-min: 0
                    input-max: 99

        - do:
            cmd: calculate_met_daily
            params:
              - record

    - name: end-of-report
      steps:
        - goto: affiliations
        - goto: set-reminder
        - goto: share
        # - goto: dynamic_update

    - name: affiliations
      steps:
        - say: ועכשיו, רוצה לענות גם על מספר שאלות לגבי תחושת לחץ ומצב רוח?
        - wait:
            variable: affiliate_questionnaires_preference
            options:
              - show: כן, רוצה
                value: ok
              - show: בפעם אחרת
                value: later
        - switch:
            arg: affiliate_questionnaires_preference
            cases:
              - match: ok
                steps:
                  - goto: affiliate-alon-chen
              - default: true
              
    - name: affiliate-alon-chen
      steps:
        - say: פרופ׳ אלון חן ממכון וייצמן וצוותו חוקרים היבטים שונים של הנוירוביולוגיה של לחץ, ומבקשים את עזרת הציבור במילוי שאלון המעריך את רמת הלחץ והחרדה בקרב האוכלוסייה, למיפוי השפעותיה, גורמיה ואסטרטגיות ההתמודדות איתה.
        - say: עבור מי הדיווח?
        - do:
            cmd: affiliate_alon_chen_prepare
            variable: _affiliate_alon_chen_options
            params:
              - בעצם, לא היום
        - wait:
            variable: _affiliate_alon_chen_choice
            optionsFrom: _affiliate_alon_chen_options
        - do:
            cmd: affiliate_alon_chen_action
            params:
              - record
              - _affiliate_alon_chen_choice
  
    # - name: dynamic_update                            # this is where we currently show map, and soon will add insihgts
    #   steps:    


    - name: share
      steps:
        - say: עוד עניין קטן… יעזור מאוד אם גם החברים והקרובים שלך ישתתפו. רוצה לשתף אותם?
        - wait:
            variable: event_share_action
            options:
              - show: כן, אשמח לשתף
                value: yes
                steps:
                  - do:
                      cmd: share_action   # (click --> add to record)
                      variable: event_share_result
                  - switch:
                      arg: event_share_result
                      cases:
                        - default: true
                        - match: copied
                          steps:
                            - do:
                                cmd: toaster
                                params:
                                  - הקישור לדיווח היומי הועתק ללוח!
                        - match: shared
                          steps:
                            - say: תודה רבה על השיתוף!
                                  

              - show: לא עכשיו
                value: no

    - name: set-reminder
      steps:
        - do:
            cmd: reminder_status   # a function to verify if a reminder was set already (telegram, device, app, downloaded ical)
            params:                #     1. no_reminder --> ask user to set a reminder 
              - record             #     2. reminder_set --> ask user to add a different/another reminder
            variable: action_reminder_required

        - switch:
            arg: action_reminder_required
            cases:
              - default: true
                steps:
                  - say: יש כמה דרכים שבהן נוכל להזכיר לך לחזור ולספר לנו מה שלומך, שננסה?
                  - wait:
                      variable: action_reminder_wanted
                      options:
                      - show: כן, אשמח לתזכורת
                        value: wanted
                        steps:
                        - goto: reminder-choose-method   # https://zpl.io/bzZMKw4

                      - show: כבר יש לי תזכורת, תודה
                        value: already_set

                      - show: לא, אין צורך, יש לי זכרון מצויין!
                        value: not_wanted
              
              - match: 'not-required'
                steps:
                  - say: תודה רבה שחזרת לדווח. מחכים לשמוע ממך שוב
              
    - name: reminder-choose-method
      steps:                   
        - do:
            cmd: reminder_choose_method_show_widget
            variable: action_reminder_selected 
            params:
              - record
        - switch:
            arg: action_reminder_selected
            cases:
              - match: notification
                steps:
                - goto: reminder-notification

              - match: android-app
                steps:
                - goto: reminder-app

              - match: iphone-app
                steps:
                - goto: reminder-app

              - match: calendar
                steps:
                - goto: reminder-calendar
            
              - match: telegram
                steps:
                - goto: reminder-telegram

    - name: reminder-notification
      steps:
        - do:
            cmd: banner
            variable: action_reminder_notification_approved
            params:
              - אשרו קבלת התראות מן האתר על מנת שנוכל להזכיר לכם למלא את השאלון
              - בסדר
        - switch:
            arg: action_reminder_notification_approved
            cases:
              - default: true
              - match: true
                steps:
                  - do:
                      cmd: install_notification
                        
    - name: reminder-app
      steps:
        - do:
            cmd: banner
            variable: action_reminder_app_approved           # track how many clicked on "download"/"nevermind"
            params:
              - הורידו את האפליקציה ונזכיר לכם כל יום ב-20:00
              - להורדת האפליקציה
        - switch:
            arg: action_reminder_app_approved
            cases:
              - default: true
              - match: true
                steps:
                  - do:
                      cmd: install_app
                      params:
                      - record
                        
    - name: reminder-calendar
      steps:
        - do:
            cmd: banner
            variable: action_reminder_calendar_approved
            params:
              - לחצו על הכפתור להתקנת התזכורת ביומן
              - להורדה
        - switch:
            arg: action_reminder_calendar_approved
            cases:
              - default: true
              - match: true
                steps:
                - do:
                    cmd: install_calendar
                - do:
                    cmd: banner
                    params:
                      - אם כלום לא קורה, פתחו את הקובץ corona_reminder.ics מה״הורדות״
                      - המשך

    - name: reminder-telegram
      steps:
        - do: 
            cmd: banner
            variable: action_reminder_telegram_approved
            params:
              - "<b>שימו לב: </b> בוט הטלגרם מופעל על ידי צד שלישי וללא כל אחריות מצדנו. מומלץ לבדוק את מדיניות שמירת המידע והפרטיות של הבוט לפני השימוש"
              - בסדר
        - switch:
            arg: action_reminder_telegram_approved
            cases:
              - default: true
              - match: true
                steps:
                - do:
                    cmd: install_telegram


- name: generic-translation-assets ## <-- keep me last!
  keys:
    - name: calendarTitle
      show: זמן לדיווח היומי למאבק בקורונה!
    - name: calendarBody
      show: "הגיע הזמן לדווח שוב כיצד אתם מרגישים! רק ביחד ננצח את הקורונה \U0001F4AA\U0001F3FD!"
    - name: reminder:notification
      show: התראה בדפדפן
    - name: reminder:calendar
      show: תזכורת ביומן
    - name: reminder:android-app
      show: אפליקציית האנדרואיד שלנו
    - name: reminder:iphone-app
      show: אפליקציית האייפון שלנו
    - name: reminder:telegram
      show: בוט טלגרם
